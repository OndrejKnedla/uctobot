# ÃšÄetnÃ­Bot Makefile
# Easy commands for testing, development, and deployment

.PHONY: help install test test-unit test-integration test-load test-all test-coverage clean format lint run dev deploy

# Default target
help:
	@echo "ğŸš€ ÃšÄetnÃ­Bot Development Commands"
	@echo "================================="
	@echo ""
	@echo "ğŸ“¦ Setup & Installation:"
	@echo "  make install          Install all dependencies"
	@echo "  make install-dev      Install dev dependencies" 
	@echo ""
	@echo "ğŸ§ª Testing:"
	@echo "  make test             Run all tests"
	@echo "  make test-unit        Run unit tests only"
	@echo "  make test-integration Run integration tests only"
	@echo "  make test-load        Run load tests"
	@echo "  make test-fast        Run tests (skip slow ones)"
	@echo "  make test-coverage    Run tests with coverage report"
	@echo ""
	@echo "ğŸ”§ Development:"
	@echo "  make format           Format code with black"
	@echo "  make lint             Run linting checks"
	@echo "  make clean            Clean temporary files"
	@echo "  make run              Run development server"
	@echo "  make dev              Run with auto-reload"
	@echo ""
	@echo "ğŸš€ Deployment:"
	@echo "  make deploy           Deploy to production"
	@echo "  make migrate          Run database migrations"

# Installation
install:
	@echo "ğŸ“¦ Installing dependencies..."
	pip install -r requirements.txt

install-dev: install
	@echo "ğŸ“¦ Installing development dependencies..."
	pip install black flake8 mypy isort

# Testing commands
test:
	@echo "ğŸ§ª Running all tests..."
	python run_tests.py --all

test-unit:
	@echo "ğŸ§ª Running unit tests..."
	python run_tests.py --unit

test-integration:
	@echo "ğŸ§ª Running integration tests..."
	python run_tests.py --integration

test-load:
	@echo "ğŸ§ª Running load tests..."
	python run_tests.py --load

test-fast:
	@echo "âš¡ Running fast tests..."
	python run_tests.py --all --fast

test-coverage:
	@echo "ğŸ“Š Running tests with coverage..."
	python run_tests.py --all --coverage
	@echo ""
	@echo "ğŸ“Š Coverage report generated:"
	@echo "  - Terminal: see output above"
	@echo "  - HTML: open htmlcov/index.html"

test-parallel:
	@echo "ğŸš€ Running tests in parallel..."
	python run_tests.py --all --parallel 4

# Code quality
format:
	@echo "ğŸ¨ Formatting code..."
	black app/ utils/ tests/ --line-length 120
	isort app/ utils/ tests/ --profile black

lint:
	@echo "ğŸ” Running linting checks..."
	flake8 app/ utils/ tests/ --max-line-length 120 --extend-ignore E203,W503
	mypy app/ utils/ --ignore-missing-imports

# Development
run:
	@echo "ğŸš€ Starting development server..."
	python -m uvicorn app.main:app --host 0.0.0.0 --port 8000

dev:
	@echo "ğŸ”„ Starting development server with auto-reload..."
	python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

# Database
migrate:
	@echo "ğŸ—„ï¸  Running database migrations..."
	alembic upgrade head

migrate-create:
	@echo "ğŸ—„ï¸  Creating new migration..."
	alembic revision --autogenerate -m "$(MSG)"

# Deployment
deploy:
	@echo "ğŸš€ Deploying to production..."
	@echo "âš ï¸  Make sure you have:"
	@echo "  1. Updated environment variables"
	@echo "  2. Run tests successfully"
	@echo "  3. Created database backups"
	@echo ""
	@read -p "Continue with deployment? [y/N]: " confirm && \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		echo "ğŸš€ Deploying..."; \
		git push origin main; \
		echo "âœ… Deployment triggered"; \
	else \
		echo "âŒ Deployment cancelled"; \
	fi

# Utilities
clean:
	@echo "ğŸ§¹ Cleaning temporary files..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	rm -rf .pytest_cache
	rm -rf htmlcov
	rm -rf .coverage
	rm -rf dist
	rm -rf build
	rm -f test_*.db
	rm -f *.pdf
	@echo "âœ… Cleanup complete"

# Docker commands
docker-build:
	@echo "ğŸ³ Building Docker image..."
	docker build -t ucetni-bot .

docker-run:
	@echo "ğŸ³ Running Docker container..."
	docker run -p 8000:8000 --env-file .env ucetni-bot

docker-test:
	@echo "ğŸ§ª Running tests in Docker..."
	docker run --rm ucetni-bot python run_tests.py --all

# Health checks
health:
	@echo "ğŸ¥ Checking application health..."
	curl -f http://localhost:8000/health || echo "âŒ Health check failed"

status:
	@echo "ğŸ“Š Application status:"
	curl -s http://localhost:8000/status | python -m json.tool || echo "âŒ Status check failed"

# Load testing with detailed metrics
load-test:
	@echo "ğŸ“ˆ Running comprehensive load test..."
	python run_tests.py --load --verbose
	
benchmark:
	@echo "âš¡ Running performance benchmarks..."
	pytest tests/test_load.py -v --benchmark-only

# Security
security-scan:
	@echo "ğŸ”’ Running security scan..."
	pip install safety bandit
	safety check
	bandit -r app/ utils/ -f json -o security-report.json || true
	@echo "ğŸ“„ Security report saved to security-report.json"

# Documentation
docs:
	@echo "ğŸ“š Generating documentation..."
	pip install sphinx
	sphinx-quickstart docs --sep --project="ÃšÄetnÃ­Bot" --author="ÃšÄetnÃ­Bot Team" -q
	@echo "ğŸ“š Documentation template created in docs/"

# Quick development cycle
quick-test: test-unit lint
	@echo "âœ… Quick development tests passed"

pre-commit: format lint test-fast
	@echo "âœ… Pre-commit checks passed"

# Environment setup
setup-env:
	@echo "âš™ï¸  Setting up environment..."
	cp .env.example .env
	@echo "ğŸ“ Edit .env with your configuration"
	@echo "ğŸ’¡ Run 'make install' to install dependencies"

# Railway deployment
railway-deploy:
	@echo "ğŸš‚ Deploying to Railway..."
	railway login
	railway deploy

railway-logs:
	@echo "ğŸ“‹ Viewing Railway logs..."
	railway logs

# Performance monitoring
monitor:
	@echo "ğŸ“Š Starting performance monitoring..."
	@echo "Metrics available at: http://localhost:8000/metrics"
	@echo "Health check at: http://localhost:8000/health"

# Backup
backup-db:
	@echo "ğŸ’¾ Creating database backup..."
	@if [ -f "ucetni_bot.db" ]; then \
		cp ucetni_bot.db "backups/ucetni_bot_$(shell date +%Y%m%d_%H%M%S).db"; \
		echo "âœ… Database backup created"; \
	else \
		echo "âŒ No database file found"; \
	fi